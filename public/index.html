<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PG-DAC Interactive Quiz</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Additional styles for the uploader */
        #uploader {
            padding: 20px;
            background: #eaf2f8;
            border: 2px dashed #3498db;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }
        #uploader h2 { margin-top: 0; color: #2980b9; }
        #uploader input[type="file"] { margin-bottom: 15px; }
        #uploader button { 
            padding: 10px 20px; 
            background: #3498db; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 1em;
        }
        #uploader button:hover { background: #2980b9; }
        #upload-status { margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>PG-DAC Interactive Quiz</h1>

    <div id="uploader">
        <h2>Upload Your Quiz File</h2>
        <form id="upload-form">
            <input type="file" id="quiz-file-input" name="quizfile" accept=".json" required>
            <button type="submit">Upload & Load Quiz</button>
        </form>
        <div id="upload-status"></div>
    </div>

    <div id="quiz-container">
        <!-- Questions will be dynamically inserted here -->
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const quizContainer = document.getElementById('quiz-container');
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('quiz-file-input');
        const uploadStatus = document.getElementById('upload-status');
        
        // Initially, try to load any existing quiz
        loadQuiz();

        // Handle the form submission for file upload
        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const file = fileInput.files[0];
            if (!file) {
                uploadStatus.textContent = 'Please select a file.';
                uploadStatus.style.color = 'red';
                return;
            }

            const formData = new FormData();
            formData.append('quizfile', file);

            try {
                uploadStatus.textContent = 'Uploading...';
                uploadStatus.style.color = 'blue';

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Upload failed');
                }
                
                uploadStatus.textContent = 'Upload successful! Loading quiz...';
                uploadStatus.style.color = 'green';

                // After successful upload, reload the quiz questions
                loadQuiz();

            } catch (error) {
                uploadStatus.textContent = `Error: ${error.message}`;
                uploadStatus.style.color = 'red';
            }
        });

        // Fetch quiz data from the server API
        async function loadQuiz() {
            // Clear any existing quiz content first
            quizContainer.innerHTML = '';
            try {
                const response = await fetch('/api/quiz');
                const quizData = await response.json();

                if (!response.ok) {
                    throw new Error(quizData.error || 'Failed to fetch quiz data.');
                }
                
                renderQuiz(quizData);

            } catch (error) {
                quizContainer.innerHTML = `<p style="color:orange;">${error.message}</p>`;
            }
        }

        // --- The rest of the functions (renderQuiz, addEventListeners, handleOptionClick) are identical to the previous answer ---

        function renderQuiz(questions) {
            questions.forEach((q, index) => {
                const questionBlock = document.createElement('div');
                questionBlock.className = 'question-block';
                questionBlock.dataset.questionIndex = index;
                const subjectTag = document.createElement('span');
                subjectTag.className = 'subject-tag';
                subjectTag.textContent = q.subject;
                questionBlock.appendChild(subjectTag);
                const questionStatement = document.createElement('p');
                questionStatement.className = 'question-statement';
                questionStatement.textContent = `Q${index + 1}: ${q.question}`;
                questionBlock.appendChild(questionStatement);
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'options-container';
                q.options.forEach((optionText, optionIndex) => {
                    const option = document.createElement('div');
                    option.className = 'option';
                    option.textContent = optionText;
                    option.dataset.index = optionIndex;
                    optionsContainer.appendChild(option);
                });
                questionBlock.appendChild(optionsContainer);
                const reasonsContainer = document.createElement('div');
                reasonsContainer.className = 'reasons-container';
                q.reasons.forEach((reasonText, reasonIndex) => {
                    const reason = document.createElement('p');
                    reason.textContent = reasonText;
                    reason.className = (reasonIndex === q.correctAnswer) ? 'correct-reason' : 'incorrect-reason';
                    reasonsContainer.appendChild(reason);
                });
                questionBlock.appendChild(reasonsContainer);
                quizContainer.appendChild(questionBlock);
            });
            addEventListeners();
        }
        
        function addEventListeners() {
            const options = document.querySelectorAll('.option');
            options.forEach(option => {
                option.addEventListener('click', handleOptionClick);
            });
        }

        async function handleOptionClick(event) {
            const selectedOption = event.target;
            const questionBlock = selectedOption.closest('.question-block');
            const optionsContainer = selectedOption.closest('.options-container');
            const reasonsContainer = questionBlock.querySelector('.reasons-container');
            const questionIndex = parseInt(questionBlock.dataset.questionIndex);
            const selectedAnswerIndex = parseInt(selectedOption.dataset.index);

            // We need to re-fetch to be sure we have the latest data
            const response = await fetch('/api/quiz');
            const quizData = await response.json();
            const question = quizData[questionIndex];
            const correctAnswerIndex = question.correctAnswer;

            if (selectedAnswerIndex === correctAnswerIndex) {
                selectedOption.classList.add('correct');
            } else {
                selectedOption.classList.add('incorrect');
                const correctOption = optionsContainer.querySelector(`[data-index='${correctAnswerIndex}']`);
                correctOption.classList.add('correct');
            }
            
            optionsContainer.classList.add('disabled');
            reasonsContainer.style.display = 'block';
        }
    });
    </script>
</body>
</html>